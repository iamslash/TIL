- [Abstract](#abstract)
- [Materials](#materials)
- [Basic](#basic)
  - [Standard Usage](#standard-usage)
  - [Foo](#foo)
- [Advanced](#advanced)
  - [Make AWS Cloudformation mock.go](#make-aws-cloudformation-mockgo)

----

# Abstract

GoMock is a mocking framework for the Go programming language. 

mocking 의 대상은 **interface** 이다. struct 는 mocking 할 수 없다.

# Materials

* [gomock @ github](https://github.com/golang/mock)
* [gomock @ go.dev](https://pkg.go.dev/github.com/golang/mock/gomock)

# Basic

## Standard Usage

```
(1) Define an interface that you wish to mock.
      type MyInterface interface {
        SomeMethod(x int64, y string)
      }
(2) Use mockgen to generate a mock from the interface.
(3) Use the mock in a test:
      func TestMyThing(t *testing.T) {
        mockCtrl := gomock.NewController(t)
        defer mockCtrl.Finish()

        mockObj := something.NewMockMyInterface(mockCtrl)
        mockObj.EXPECT().SomeMethod(4, "blah")
        // pass mockObj to a real object and play with it.
      }
```

## Foo

> directory

```bash
$ tree go-ex-mock
go-ex-mock
├── cmd
│   └── main
│       └── main.go
├── foo
│   ├── foo.go
│   ├── foo_test.go
│   └── mock_foo_test.go
├── go.mod
└── go.sum

3 directories, 6 files
```

> `cmd/main/main.go`

```go
package main

import (
	"fmt"

	"github.com/iamslash/go-ex/go-ex-mock/foo"
)

func main() {
	foo := foo.Impl{}
	fmt.Println(foo.Bar(1234))
}
```

> `go.mod`

```go
module github.com/iamslash/go-ex/go-ex-mock

go 1.16

require github.com/golang/mock v1.6.0
```

> `foo/foo.go`

```go
package foo

//go:generate mockgen -destination mock_foo_test.go -package foo_test github.com/iamslash/go-ex/go-ex-mock/foo Foo

type Foo interface {
	Bar(x int) int
}

type Impl struct {}

func (f *Impl) Bar(x int) int {
	return x
}
```

이제 `$ go generate ./...` 를 실행하여 `foo/mock_foo_test.go` 를 생성한다.

```go
// Code generated by MockGen. DO NOT EDIT.
// Source: github.com/iamslash/go-ex/go-ex-mock/foo (interfaces: Foo)

// Package foo_test is a generated GoMock package.
package foo_test

import (
	reflect "reflect"

	gomock "github.com/golang/mock/gomock"
)

// MockFoo is a mock of Foo interface.
type MockFoo struct {
	ctrl     *gomock.Controller
	recorder *MockFooMockRecorder
}

// MockFooMockRecorder is the mock recorder for MockFoo.
type MockFooMockRecorder struct {
	mock *MockFoo
}

// NewMockFoo creates a new mock instance.
func NewMockFoo(ctrl *gomock.Controller) *MockFoo {
	mock := &MockFoo{ctrl: ctrl}
	mock.recorder = &MockFooMockRecorder{mock}
	return mock
}

// EXPECT returns an object that allows the caller to indicate expected use.
func (m *MockFoo) EXPECT() *MockFooMockRecorder {
	return m.recorder
}

// Bar mocks base method.
func (m *MockFoo) Bar(arg0 int) int {
	m.ctrl.T.Helper()
	ret := m.ctrl.Call(m, "Bar", arg0)
	ret0, _ := ret[0].(int)
	return ret0
}

// Bar indicates an expected call of Bar.
func (mr *MockFooMockRecorder) Bar(arg0 interface{}) *gomock.Call {
	mr.mock.ctrl.T.Helper()
	return mr.mock.ctrl.RecordCallWithMethodType(mr.mock, "Bar", reflect.TypeOf((*MockFoo)(nil).Bar), arg0)
}
```

mocking 의 대상은 `Foo` interface 이다. `MockFoo` 은 gomock 이 생성한 fake
struct 이다. 다음을 주의 깊게 살피자.

* `MockFoo` 의 instance 는 `ctrl *gomock.Controller` 와 `recorder
  *MockFooMockRecorder` 를 field 로 갖는다.
* `MockFoo.EXPECT()` 는 `recorder` 를 리턴한다.
* `MockFooMockRecorder.Bar(arg0 interface{})` 를 호출하여 합의된 argument 를
  전달한다. 또한 `*gomock.Call` 을 리턴한다.
* `*gomock.Call.Return(rets ...interface{})` 는 return value 를 합의한다.
* `MockFoo.Bar(arg0 int)` 는 `ctrl` 에 저장된 return value 를 리턴한다. 특정
  argument 가 전달되면 특정 value 가 리턴되도록 합의되어 있다.

> `foo/foo_test.go`

```go
package foo_test

import (
	"testing"

	"github.com/golang/mock/gomock"
	"github.com/iamslash/go-ex/go-ex-mock/foo"
)

func TestImplBar(t *testing.T) {
	cases := []struct {
		in, want int
	}{
		{1, 1},
		{2, 2},
		{3, 3},
	}
	for _, c := range cases {
		f := foo.Impl{}
		got := f.Bar(c.in)
		if got != c.want {
			t.Errorf("foo.Impl.Bar(%q) == %q, want %q", c.in, got, c.want)
		}
	}
}

func TestFooBar(t *testing.T) {
	ctrl := gomock.NewController(t)

	// given
	mockFoo := NewMockFoo(ctrl)

	// when
	mockFoo.
		EXPECT().
		Bar(1).
		Return(1)

	// then
	mockFoo.Bar(1)
}
```

다음과 같이 test 해본다.

```bash
$ go test ./...
```

# Advanced

## Make AWS Cloudformation mock.go

* [aws-nuke @ github](https://github.com/rebuy-de/aws-nuke/blob/master/resources/cloudformation-stack_test.go)

```bash
#!/bin/sh
go run github.com/golang/mock/mockgen -source $(go list -m -f "{{.Dir}}" "github.com/aws/aws-sdk-go")/service/cloudformation/cloudformationiface/interface.go -destination mocks/mock_cloudformationiface/mock.go
```
