- [1. OS 프로세스의 메모리 레이아웃](#1-os-프로세스의-메모리-레이아웃)
- [2. Go 런타임이 관리하는 메모리 레이아웃](#2-go-런타임이-관리하는-메모리-레이아웃)
- [3. OS 프로세스와 Go 런타임 메모리 레이아웃 통합](#3-os-프로세스와-go-런타임-메모리-레이아웃-통합)
  - [4. 메모리 영역별 상세 설명](#4-메모리-영역별-상세-설명)
    - [**OS 관점에서의 메모리 영역**](#os-관점에서의-메모리-영역)
    - [**Go 런타임 관점에서의 메모리 관리**](#go-런타임-관점에서의-메모리-관리)
  - [5. 메모리 할당 흐름](#5-메모리-할당-흐름)
  - [6. 핵심 포인트 요약](#6-핵심-포인트-요약)
    - [**OS 프로세스 관점**](#os-프로세스-관점)
    - [**Go 런타임 관점**](#go-런타임-관점)
    - [**메모리 관리의 이중성**](#메모리-관리의-이중성)

-----

# 1. OS 프로세스의 메모리 레이아웃

```
┌─────────────────────────────────────────────────────────────┐
│                    OS 프로세스 가상 메모리 공간              │
│                    (64비트 시스템 예시)                     │
├─────────────────────────────────────────────────────────────┤
│ 0xFFFFFFFFFFFFFFFF (최고 주소)                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                    커널 공간                              │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  시스템 콜 인터페이스                               │ │ │
│ │  │  커널 코드 및 데이터                                │ │ │
│ │  │  디바이스 드라이버                                  │ │ │
│ │  │  인터럽트 핸들러                                    │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                    사용자 공간                           │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  스택 영역 (Stack)                                 │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  환경 변수                                      │ │ │ │
│ │  │  │  명령행 인수                                    │ │ │ │
│ │  │  │  스레드 스택들 (OS 스레드용)                    │ │ │ │
│ │  │  │  지역 변수, 함수 호출 프레임                    │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ │                                                         │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  힙 영역 (Heap)                                    │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  동적 할당 메모리                               │ │ │ │
│ │  │  │  malloc/new으로 할당된 메모리                   │ │ │ │
│ │  │  │  Go 런타임이 관리하는 메모리                    │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ │                                                         │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  BSS 영역 (Block Started by Symbol)                │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  초기화되지 않은 전역 변수                      │ │ │ │
│ │  │  │  정적 변수 (0으로 초기화)                       │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ │                                                         │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  데이터 영역 (Data)                                │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  초기화된 전역 변수                             │ │ │ │
│ │  │  │  정적 변수 (초기값 있음)                        │ │ │ │
│ │  │  │  문자열 리터럴                                  │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ │                                                         │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  텍스트 영역 (Text/Code)                           │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  실행 가능한 코드                               │ │ │ │
│ │  │  │  함수 정의들                                    │ │ │ │
│ │  │  │  상수 데이터                                    │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 0x0000000000000000 (최저 주소)                              │
└─────────────────────────────────────────────────────────────┘
```

# 2. Go 런타임이 관리하는 메모리 레이아웃

```
┌─────────────────────────────────────────────────────────────┐
│                    Go 런타임 메모리 관리 영역                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                Go 힙 영역 (GC 관리)                     │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  사용자 힙 객체들                                  │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  *b = 2 (int) - new(int)로 할당               │ │ │ │
│ │  │  │  "Hello World" - 문자열 리터럴                │ │ │ │
│ │  │  │  슬라이스, 맵, 채널 등                        │ │ │ │
│ │  │  │  사용자 정의 구조체                            │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  런타임 힙 객체들                                  │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  mheap 구조체                                  │ │ │ │
│ │  │  │  mspan 구조체들                                │ │ │ │
│ │  │  │  mcache 구조체들                               │ │ │ │
│ │  │  │  GC 관련 데이터 구조                           │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                Go 스택 영역 (GC 미관리)                 │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  main goroutine 스택                              │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  main() 함수 스택 프레임                       │ │ │ │
│ │  │  │  ┌─────────────────────────────────────────────┐ │ │ │ │
│ │  │  │  │  a = 1 (int) - 스택 변수                  │ │ │ │ │
│ │  │  │  │  b = 0x12345678 (*int) - 힙 포인터        │ │ │ │ │
│ │  │  │  │  반환 주소, 프레임 포인터                  │ │ │ │ │
│ │  │  │  └─────────────────────────────────────────────┘ │ │ │ │
│ │  │  │  ┌─────────────────────────────────────────────┐ │ │ │ │
│ │  │  │  │  fmt.Println() 스택 프레임                 │ │ │ │ │
│ │  │  │  └─────────────────────────────────────────────┘ │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  g0 (스케줄러) 스택                               │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  스케줄러 함수들                               │ │ │ │
│ │  │  │  GC 관련 함수들                                │ │ │ │
│ │  │  │  시스템 콜 처리                                │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  sysmon 스택                                      │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  시스템 모니터링 함수들                        │ │ │ │
│ │  │  │  P 재할당 로직                                 │ │ │ │
│ │  │  │  장시간 실행 G preemption                      │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  기타 goroutine 스택들                            │ │ │
│ │  │  (사용자가 생성한 goroutine들)                     │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                Go 런타임 데이터 영역                    │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  전역 런타임 구조체들                              │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  sched (스케줄러)                              │ │ │ │
│ │  │  │  allg (모든 goroutine 리스트)                  │ │ │ │
│ │  │  │  allm (모든 M 리스트)                          │ │ │ │
│ │  │  │  allp (모든 P 리스트)                          │ │ │ │
│ │  │  │  memstats (메모리 통계)                        │ │ │ │
│ │  │  │  work (GC 작업 큐)                             │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

# 3. OS 프로세스와 Go 런타임 메모리 레이아웃 통합

```
┌─────────────────────────────────────────────────────────────┐
│                    OS 프로세스 가상 메모리 공간              │
│                    (Go 애플리케이션 실행 시)                 │
├─────────────────────────────────────────────────────────────┤
│ 0xFFFFFFFFFFFFFFFF (최고 주소)                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                    커널 공간                              │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  시스템 콜, 커널 코드, 디바이스 드라이버 등         │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                    사용자 공간                           │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  OS 스택 영역                                      │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  환경 변수, 명령행 인수                        │ │ │ │
│ │  │  │  OS 스레드 스택 (Go에서는 거의 사용 안함)      │ │ │ │
│ │  │  └─────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────┘ │ │
│ │                                                         │ │
│ │  ┌─────────────────────────────────────────────────────┐ │ │
│ │  │  OS 힙 영역 (Go 런타임이 사용)                     │ │ │
│ │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│ │  │  │  Go 힙 영역 (GC 관리)                          │ │ │ │
│ │  │  │  ┌─────────────────────────────────────────────┐ │ │ │ │
│ │  │  │  │  사용자 힙 객체들                          │ │ │ │ │
│ │  │  │  │  ┌─────────────────────────────────────────┐ │ │ │ │ │
│ │  │  │  │  │  *b = 2 (int)                         │ │ │ │ │ │
│ │  │  │  │  │  "Hello World" 문자열                  │ │ │ │ │ │
│ │  │  │  │  │  슬라이스, 맵, 채널 등                 │ │ │ │ │ │
│ │  │  │  │  └─────────────────────────────────────────┘ │ │ │ │ │
│ │  │  │  └─────────────────────────────────────────────┘ │ │ │ │
│ │  │  │  ┌─────────────────────────────────────────────┐ │ │ │ │
│ │  │  │  │  런타임 힙 객체들                          │ │ │ │ │
│ │  │  │  │  mheap, mspan, mcache, GC 데이터 등        │ │ │ │ │
│ │  │  │  └─────────────────────────────────────────────┘ │ │ │ │
│ │  │  └─────────────────────────────────────────────────────┘ │ │ │
│ │  │  ┌─────────────────────────────────────────────────────┐ │ │ │
│ │  │  │  Go 스택 영역 (GC 미관리)                         │ │ │ │
│ │  │  │  ┌─────────────────────────────────────────────────┐ │ │ │ │ │
│ │  │  │  │  main goroutine 스택                          │ │ │ │ │ │
│ │  │  │  │  ┌─────────────────────────────────────────────┐ │ │ │ │ │ │
│ │  │  │  │  │  a = 1 (스택 변수)                        │ │ │ │ │ │ │
│ │  │  │  │  │  b = 0x12345678 (힙 포인터)               │ │ │ │ │ │ │
│ │  │  │  │  │  함수 호출 프레임들                       │ │ │ │ │ │ │
│ │  │  │  │  └─────────────────────────────────────────────┘ │ │ │ │ │ │
│ │  │  │  └─────────────────────────────────────────────────┘ │ │ │ │ │
│ │  │  │  ┌─────────────────────────────────────────────────┐ │ │ │ │ │
│ │  │  │  │  g0, sysmon, 기타 goroutine 스택들            │ │ │ │ │ │
│ │  │  │  └─────────────────────────────────────────────────┘ │ │ │ │ │
│ │  │  └─────────────────────────────────────────────────────┘ │ │ │ │
│ │  └─────────────────────────────────────────────────────────┘ │ │
│ │                                                             │ │
│ │  ┌─────────────────────────────────────────────────────────┐ │ │
│ │  │  BSS 영역                                              │ │ │
│ │  │  ┌─────────────────────────────────────────────────────┐ │ │ │
│ │  │  │  Go 런타임 전역 변수들 (초기화되지 않은)           │ │ │ │
│ │  │  │  sched, allg, allm, allp, memstats 등              │ │ │ │
│ │  │  └─────────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────────┘ │ │
│ │                                                             │ │
│ │  ┌─────────────────────────────────────────────────────────┐ │ │
│ │  │  데이터 영역                                           │ │ │
│ │  │  ┌─────────────────────────────────────────────────────┐ │ │ │
│ │  │  │  Go 런타임 전역 변수들 (초기화된)                 │ │ │ │
│ │  │  │  상수, 문자열 리터럴 등                            │ │ │ │
│ │  │  └─────────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────────┘ │ │
│ │                                                             │ │
│ │  ┌─────────────────────────────────────────────────────────┐ │ │
│ │  │  텍스트 영역 (코드)                                    │ │ │
│ │  │  ┌─────────────────────────────────────────────────────┐ │ │ │
│ │  │  │  Go 런타임 코드                                    │ │ │ │
│ │  │  │  사용자 코드 (main 함수, fmt.Println 등)           │ │ │ │
│ │  │  │  라이브러리 코드                                   │ │ │ │
│ │  │  └─────────────────────────────────────────────────────┘ │ │ │
│ │  └─────────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                             │
│ 0x0000000000000000 (최저 주소)                              │
└─────────────────────────────────────────────────────────────┘
```

## 4. 메모리 영역별 상세 설명

### **OS 관점에서의 메모리 영역**

| 영역 | OS 역할 | Go 런타임 사용 |
|------|---------|----------------|
| **텍스트** | 실행 코드 | Go 런타임 코드, 사용자 코드 |
| **데이터** | 초기화된 전역 변수 | Go 런타임 전역 변수 |
| **BSS** | 초기화되지 않은 전역 변수 | Go 런타임 전역 구조체 |
| **힙** | 동적 할당 메모리 | Go 힙 + Go 스택 영역 |
| **스택** | 함수 호출 스택 | OS 스레드 스택 (거의 사용 안함) |

### **Go 런타임 관점에서의 메모리 관리**

| 영역 | GC 관리 | 설명 |
|------|---------|------|
| **Go 힙** | ✅ 관리 | 사용자 객체, 런타임 객체 |
| **Go 스택** | ❌ 미관리 | goroutine 스택 (자동 해제) |
| **런타임 데이터** | ❌ 미관리 | 전역 구조체들 |

## 5. 메모리 할당 흐름

```
사용자 코드 실행
       ↓
Go 런타임이 메모리 할당 결정
       ↓
┌─────────────────┬─────────────────┐
│   스택 할당     │    힙 할당      │
│   (자동 해제)   │   (GC 관리)     │
└─────────────────┴─────────────────┘
       ↓                   ↓
OS 힙 영역에서          OS 힙 영역에서
스택 메모리 할당        힙 메모리 할당
       ↓                   ↓
Go 스택 영역에 저장    Go 힙 영역에 저장
(GC 미관리)           (GC 관리)
```

## 6. 핵심 포인트 요약

### **OS 프로세스 관점**
- Go 애플리케이션은 하나의 OS 프로세스
- 전통적인 메모리 레이아웃 (텍스트, 데이터, BSS, 힙, 스택) 유지
- OS는 Go 런타임이 힙 영역을 어떻게 사용하는지 모름

### **Go 런타임 관점**
- OS 힙 영역을 **Go 힙**과 **Go 스택**으로 세분화
- **Go 힙**: GC가 관리하는 사용자 객체와 런타임 객체
- **Go 스택**: GC가 관리하지 않는 goroutine 스택들
- **런타임 데이터**: 전역 구조체들 (sched, allg, allm 등)

### **메모리 관리의 이중성**
1. **OS 레벨**: 프로세스 전체 메모리 관리
2. **Go 런타임 레벨**: 힙과 스택의 세분화된 관리

이러한 구조를 통해 Go는 OS의 메모리 관리 시스템 위에 자체적인 메모리 관리 시스템을 구축하여 효율적인 가비지 컬렉션과 goroutine 스택 관리를 제공합니다.
